version: 2.1

commands:
  build_app:
    steps:
      - add_ssh_keys
      - run:
          name: Add to known hosts
          command: |
            mkdir -p ~/.ssh/
            ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
      - run:
          name: git pull
          command: |
            ssh $SSH_USER@$SSH_HOST "cd /home/alex/bustail_core && git pull"
      - run:
          name: install requirements for test
          command: |
            ssh $SSH_USER@$SSH_HOST "cd /home/alex/bustail_core/backend && python3 -m pytest"
          environment:
            - ENV: DEV
            - SERVER: https
              DOMAIN: bustail.online
            - MAILING_SECRET_KEY: test
            - MAILING_EMAIL: alexanderdemure@gmail.com
            - MAILING_NAME: Bustail
            - YANDEX_ACCESS_KEY_ID: test
            - YANDEX_SECRET_ACCESS_KEY: test
            - YANDEX_BUCKET_NAME: bustail
            - REDIS_HOST: localhost
            - REDIS_DB: 0
            - REDIS_PORT: 6379
            - REDIS_PASSWORD: foobared

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: test-results


#      - run:
#          name: Docker-compose up
#          command: |
#            ssh $SSH_USER@$SSH_HOST "cd /home/alex/bustail_core && docker-compose -f $CFG_NAME up -d --build"
#      - run:
#          name: Docker-compose logs
#          command: |
#            ssh $SSH_USER@$SSH_HOST "cd /home/alex/bustail_core && docker-compose -f $CFG_NAME logs --tail="10""

jobs:
  build:
    docker:
      - image: 'cimg/base:2021.01'
    steps:
      - build_app


workflows:
  version: 2.1
  build-and-deploy-prod:
    jobs:
      - build:
          context:
            - Production
          filters:
            branches:
              only:
                - master
